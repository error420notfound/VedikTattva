<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Image Exposure Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-neutral-100 min-h-screen flex items-center justify-center">

  <div class="bg-white w-full max-w-xl p-8 rounded-2xl shadow-xl">

    <!-- PAGE 1 -->
    <section id="page1" class="space-y-6 text-center">
      <h1 class="text-2xl font-semibold">Perception Test</h1>
      <p class="text-neutral-600">Press start to begin the test.</p>
      <button id="startTest"
        class="w-full bg-black text-white py-2 rounded-lg">
        Start Test
      </button>
    </section>

    <!-- PAGE 2 -->
    <section id="page2" class="hidden text-center space-y-6">

      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="hidden flex justify-center">
        <div class="w-8 h-8 border-4 border-neutral-300 border-t-black rounded-full animate-spin"></div>
      </div>

      <!-- Image -->
      <div id="imageContainer" class="hidden">
        <img id="testImage"
          class="max-h-96 mx-auto object-contain">

        <!-- Progress Bar -->
        <div class="w-full bg-neutral-200 h-2 mt-4 rounded overflow-hidden">
          <div id="progressBar"
            class="h-2 bg-black/60 w-0"></div>
        </div>
      </div>

      <!-- Vertical Buttons -->
      <div id="resultButtons" class="hidden flex flex-col space-y-4">
        <button id="passBtn"
          class="bg-green-600 text-white px-6 py-2 rounded-lg w-full">
          Pass
        </button>
        <button id="failBtn"
          class="border border-red-600 text-red-600 px-6 py-2 rounded-lg w-full">
          Fail
        </button>
      </div>

      <p id="attemptInfo" class="text-sm text-neutral-500"></p>
    </section>

    <!-- PAGE 3 -->
    <section id="page3" class="hidden text-center space-y-6">

      <div id="resultCard" class="p-6 border rounded-xl bg-white">
        <h2 class="text-2xl font-semibold mb-4">Perception Test Result</h2>
        <p id="summaryText" class="text-lg mb-2"></p>
        <p id="metaInfo" class="text-sm text-neutral-500"></p>
      </div>

      <button id="shareBtn"
        class="bg-black text-white px-6 py-2 rounded-lg w-full">
        Share Result
      </button>

      <button id="restartBtn"
        class="border border-black text-black px-6 py-2 rounded-lg w-full">
        Restart
      </button>

    </section>

  </div>

<script>
const imageURL = "https://raw.githubusercontent.com/error420notfound/webHTML/refs/heads/main/Frame%203.png";
const durations = [500, 1000, 1500, 2000];

let currentDurationIndex = 0;
let failCount = 0;
let totalAttempts = 0;
let passedDuration = null;

const page1 = document.getElementById('page1');
const page2 = document.getElementById('page2');
const page3 = document.getElementById('page3');

const imageContainer = document.getElementById('imageContainer');
const testImage = document.getElementById('testImage');
const progressBar = document.getElementById('progressBar');

const resultButtons = document.getElementById('resultButtons');
const attemptInfo = document.getElementById('attemptInfo');
const summaryText = document.getElementById('summaryText');
const metaInfo = document.getElementById('metaInfo');
const shareBtn = document.getElementById('shareBtn');
const loadingIndicator = document.getElementById('loadingIndicator');

testImage.src = imageURL;

// START
document.getElementById('startTest').addEventListener('click', () => {
  page1.classList.add('hidden');
  page2.classList.remove('hidden');
  initiateExposure();
});

function initiateExposure() {
  resultButtons.classList.add('hidden');
  imageContainer.classList.add('hidden');
  loadingIndicator.classList.remove('hidden');

  setTimeout(() => {
    loadingIndicator.classList.add('hidden');
    runExposure();
  }, 400);
}

function runExposure() {
  const duration = durations[currentDurationIndex];

  imageContainer.classList.remove('hidden');

  attemptInfo.textContent =
    `Duration: ${duration/1000}s | Attempt ${failCount + 1} of 3`;

  progressBar.style.transition = 'none';
  progressBar.style.width = '0%';
  void progressBar.offsetWidth;

  progressBar.style.transition = `width ${duration}ms linear`;
  progressBar.style.width = '100%';

  setTimeout(() => {
    imageContainer.classList.add('hidden');
    resultButtons.classList.remove('hidden');
  }, duration);
}

// PASS
document.getElementById('passBtn').addEventListener('click', () => {
  totalAttempts++;
  passedDuration = durations[currentDurationIndex];

  page2.classList.add('hidden');
  page3.classList.remove('hidden');

  summaryText.textContent =
    `Passed at ${passedDuration/1000}s after ${totalAttempts} attempts.`;

  metaInfo.textContent =
    `Escalation Level: ${currentDurationIndex + 1} of ${durations.length}`;
});

// FAIL
document.getElementById('failBtn').addEventListener('click', () => {
  totalAttempts++;
  failCount++;

  if (failCount >= 3) {
    currentDurationIndex++;
    failCount = 0;
  }

  if (currentDurationIndex >= durations.length) {
    page2.classList.add('hidden');
    page3.classList.remove('hidden');

    summaryText.textContent =
      `Test failed after ${totalAttempts} attempts.`;

    metaInfo.textContent =
      `Maximum duration (2s) reached without success.`;
    return;
  }

  initiateExposure();
});

// SHARE
shareBtn.addEventListener('click', async () => {

  shareBtn.disabled = true;
  shareBtn.textContent = "Generating...";

  const card = document.getElementById('resultCard');
  const canvas = await html2canvas(card);

  const blob = await new Promise(resolve =>
    canvas.toBlob(resolve, "image/png")
  );

  const file = new File([blob], "perception-test-result.png", {
    type: "image/png"
  });

  if (navigator.share && navigator.canShare({ files: [file] })) {
    await navigator.share({
      title: "Perception Test Result",
      text: "Here is my test result.",
      files: [file]
    });
  } else {
    const link = document.createElement('a');
    link.href = canvas.toDataURL("image/png");
    link.download = "perception-test-result.png";
    link.click();
  }

  shareBtn.disabled = false;
  shareBtn.textContent = "Share Result";
});

// RESTART
document.getElementById('restartBtn').addEventListener('click', () => {
  currentDurationIndex = 0;
  failCount = 0;
  totalAttempts = 0;
  passedDuration = null;

  page3.classList.add('hidden');
  page1.classList.remove('hidden');
});
</script>

</body>
</html>
