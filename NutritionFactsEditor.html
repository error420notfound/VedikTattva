<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutrition Facts Label Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link id="google-font-link" href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root { --label-font: 'Frank Ruhl Libre', serif; }
  body { background: #1a1a2e; font-family: 'Segoe UI', sans-serif; }

  /* â”€â”€ Label Styles â€” all px for consistent export â”€â”€ */
  #label {
    font-family: var(--label-font);
    background: #fff;
    color: #000;
    width: 340px;
    padding: 5px 7px 6px;
    border: 2px solid #000;
    box-sizing: border-box;
    user-select: none;
    font-size: 13px;
    line-height: 1.15;
  }
  #label * { box-sizing: border-box; }
  #label .title { font-size: 32px; font-weight: 900; line-height: 1; margin: 0 0 1px 0; }
  #label .serving-line { font-size: 10px; margin: 1px 0 0 0; line-height: 1.2; }
  #label .serving-bold { font-size: 11px; font-weight: 700; display: flex; justify-content: space-between; align-items: baseline; margin: 1px 0 0 0; }
  #label .thick-bar { height: 8px; background: #000; margin: 3px 0; }
  #label .medium-bar { height: 4px; background: #000; margin: 2px 0; }
  #label .amt-label { font-size: 9px; line-height: 1.2; margin: 0; }
  #label .calories-row { display: flex; justify-content: space-between; align-items: baseline; margin: 0; }
  #label .cal-label { font-size: 21px; font-weight: 700; line-height: 1; }
  #label .cal-value { font-size: 38px; font-weight: 900; line-height: 0.95; }
  #label .dv-header { text-align: right; font-size: 9px; margin: 2px 0 1px 0; line-height: 1; }
  #label .nutrient-row { display: flex; justify-content: space-between; align-items: baseline; font-size: 11px; padding: 1px 0; border-top: 1px solid #000; line-height: 1.2; margin: 0; }
  #label .indent1 { padding-left: 14px; }
  #label .indent2 { padding-left: 28px; }
  #label .bold { font-weight: 700; }
  #label .micro-section { font-size: 10px; }
  #label .micro-row { display: flex; justify-content: space-between; align-items: baseline; padding: 1px 0; border-top: 1px solid #000; line-height: 1.2; margin: 0; }
  #label .footnote { font-size: 8px; margin-top: 3px; border-top: 1px solid #000; padding-top: 3px; line-height: 1.35; }

  /* Editable spans */
  .editable {
    outline: none;
    cursor: text;
    display: inline;        /* inline avoids block-level spacing artifacts */
  }
  /* Edit indicators ONLY shown on screen, never bleed into export */
  #label.edit-mode .editable {
    border-bottom: 1.5px dashed rgba(37,99,235,0.7);
    padding-bottom: 1px;
  }
  #label.edit-mode .editable:focus {
    border-bottom: 2px solid #2563eb;
    background: rgba(37,99,235,0.08);
    border-radius: 1px;
    padding-bottom: 1px;
  }

  /* â”€â”€ Panel Styles â”€â”€ */
  .panel { background: #16213e; border: 1px solid #0f3460; border-radius: 12px; }
  .panel-title { color: #e94560; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
  .ctrl-btn {
    background: #0f3460;
    color: #e2e8f0;
    border: 1px solid #1e4d8c;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .ctrl-btn:hover { background: #1e4d8c; border-color: #e94560; color: #fff; }
  .ctrl-btn.active { background: #e94560; border-color: #e94560; color: #fff; }
  select, input[type=range] { background: #0f3460; color: #e2e8f0; border: 1px solid #1e4d8c; border-radius: 6px; padding: 4px 8px; font-size: 0.78rem; width: 100%; }
  label { color: #94a3b8; font-size: 0.72rem; }

  /* Export buttons */
  .export-btn {
    display: flex; align-items: center; gap: 8px; justify-content: center;
    padding: 10px 20px; border-radius: 8px; font-size: 0.82rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s; border: none; width: 100%;
  }
  .btn-pdf { background: linear-gradient(135deg,#e94560,#c0392b); color: #fff; }
  .btn-png { background: linear-gradient(135deg,#0f3460,#1a5276); color: #fff; border: 1px solid #2e86c1; }
  .btn-pdf:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(233,69,96,0.4); }
  .btn-png:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15,52,96,0.6); }

  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: #10b981; color: #fff; padding: 10px 18px;
    border-radius: 8px; font-size: 0.8rem; font-weight: 600;
    opacity: 0; transform: translateY(8px);
    transition: all 0.3s; pointer-events: none; z-index: 999;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* Label width slider feedback */
  #label-wrap { display: flex; justify-content: center; }
</style>
</head>
<body class="min-h-screen p-6">

<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-black text-white tracking-tight">Nutrition <span style="color:#e94560">Facts</span> Editor</h1>
    <p class="text-slate-400 text-sm mt-1">Click any field on the label to edit it in real-time</p>
  </div>

  <div class="flex flex-col lg:flex-row gap-6 items-start">

    <!-- â”€â”€ LEFT PANEL: Controls â”€â”€ -->
    <div class="w-full lg:w-64 flex-shrink-0 space-y-4">

      <!-- Edit Toggle -->
      <div class="panel p-4">
        <div class="panel-title">Mode</div>
        <button id="editToggleBtn" class="ctrl-btn active w-full justify-center" onclick="toggleEdit()">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-8 8a2 2 0 01-.878.515l-3 .75a.5.5 0 01-.607-.607l.75-3a2 2 0 01.515-.878l8-8z"/></svg>
          Edit Mode: ON
        </button>
      </div>

      <!-- Font Style -->
      <div class="panel p-4">
        <div class="panel-title">Font Style</div>
        <label class="block mb-1">Google Font</label>
        <select id="fontSelect" onchange="changeFont(this.value)">
          <optgroup label="â”€â”€ Serif (Original Style) â”€â”€">
            <option value="Frank+Ruhl+Libre:wght@400;700;900">Frank Ruhl Libre (Default)</option>
            <option value="Playfair+Display:wght@400;700;900">Playfair Display</option>
            <option value="Merriweather:wght@400;700;900">Merriweather</option>
            <option value="Source+Serif+4:wght@400;700;900">Source Serif 4</option>
            <option value="Libre+Baskerville:wght@400;700">Libre Baskerville</option>
            <option value="DM+Serif+Display">DM Serif Display</option>
            <option value="Crimson+Text:wght@400;700">Crimson Text</option>
            <option value="Lora:wght@400;700">Lora</option>
            <option value="EB+Garamond:wght@400;700;800">EB Garamond</option>
            <option value="Cormorant+Garamond:wght@400;700">Cormorant Garamond</option>
          </optgroup>
          <optgroup label="â”€â”€ Sans-Serif (Modern) â”€â”€">
            <option value="Inter:wght@400;700;900">Inter</option>
            <option value="DM+Sans:wght@400;700;900">DM Sans</option>
            <option value="Manrope:wght@400;700;800">Manrope</option>
            <option value="Plus+Jakarta+Sans:wght@400;700;800">Plus Jakarta Sans</option>
            <option value="Outfit:wght@400;700;900">Outfit</option>
            <option value="Nunito:wght@400;700;900">Nunito</option>
            <option value="Poppins:wght@400;700;900">Poppins</option>
            <option value="Mulish:wght@400;700;900">Mulish</option>
            <option value="Figtree:wght@400;700;900">Figtree</option>
            <option value="Noto+Sans:wght@400;700;900">Noto Sans</option>
            <option value="Public+Sans:wght@400;700;900">Public Sans</option>
            <option value="Rubik:wght@400;700;900">Rubik</option>
            <option value="Karla:wght@400;700;800">Karla</option>
            <option value="Lato:wght@400;700;900">Lato</option>
            <option value="Raleway:wght@400;700;900">Raleway</option>
            <option value="Work+Sans:wght@400;700;900">Work Sans</option>
            <option value="Sora:wght@400;700;800">Sora</option>
            <option value="Jost:wght@400;700;900">Jost</option>
            <option value="Space+Grotesk:wght@400;700">Space Grotesk</option>
          </optgroup>
          <optgroup label="â”€â”€ Condensed / Display â”€â”€">
            <option value="Oswald:wght@400;700">Oswald</option>
            <option value="Roboto+Condensed:wght@400;700">Roboto Condensed</option>
            <option value="Bebas+Neue">Bebas Neue</option>
            <option value="Barlow+Condensed:wght@400;700">Barlow Condensed</option>
            <option value="Fjalla+One">Fjalla One</option>
            <option value="Big+Shoulders+Display:wght@400;700;900">Big Shoulders Display</option>
            <option value="Antonio:wght@400;700">Antonio</option>
          </optgroup>
          <optgroup label="â”€â”€ Monospace â”€â”€">
            <option value="JetBrains+Mono:wght@400;700">JetBrains Mono</option>
            <option value="Space+Mono:wght@400;700">Space Mono</option>
            <option value="IBM+Plex+Mono:wght@400;700">IBM Plex Mono</option>
            <option value="Inconsolata:wght@400;700">Inconsolata</option>
          </optgroup>
        </select>
      </div>

      <!-- Label Size -->
      <div class="panel p-4">
        <div class="panel-title">Label Size</div>
        <label class="block mb-1">Width: <span id="widthVal">340</span>px</label>
        <input type="range" min="260" max="520" value="340" oninput="resizeLabel(this.value)">
      </div>

      <!-- Border -->
      <div class="panel p-4">
        <div class="panel-title">Border</div>
        <label class="block mb-1">Thickness: <span id="borderVal">2</span>px</label>
        <input type="range" min="0" max="6" value="2" oninput="updateBorder(this.value)">
      </div>

      <!-- Export -->
      <div class="panel p-4">
        <div class="panel-title">Export</div>
        <div class="space-y-3">
          <button class="export-btn btn-pdf" onclick="exportPDF()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M9 13h6M9 17h3"/></svg>
            Export as PDF
          </button>
          <button class="export-btn btn-png" onclick="exportPNG()">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9l4-4 4 4 5-5 5 5"/></svg>
            Export as PNG
          </button>
        </div>
      </div>

      <!-- Reset -->
      <div class="panel p-4">
        <button class="ctrl-btn w-full justify-center" onclick="resetLabel()">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
          Reset to Defaults
        </button>
      </div>
    </div>

    <!-- â”€â”€ CENTER: Label Preview â”€â”€ -->
    <div class="flex-1 flex justify-center">
      <div id="label-wrap">
        <div id="label" class="edit-mode">
          <!-- Title -->
          <div class="title" id="lbl-title"><span class="editable" contenteditable="true" spellcheck="false">Nutrition Facts</span></div>

          <!-- Servings -->
          <div class="serving-line"><span class="editable" contenteditable="true" spellcheck="false">8</span> servings per container</div>
          <div class="serving-bold">
            <span>Serving size</span>
            <span class="editable" contenteditable="true" spellcheck="false">2/3 cup (55g)</span>
          </div>

          <div class="thick-bar"></div>

          <!-- Calories -->
          <div class="amt-label">Amount per serving</div>
          <div class="calories-row">
            <span class="cal-label">Calories</span>
            <span class="cal-value editable" contenteditable="true" spellcheck="false">230</span>
          </div>

          <div class="medium-bar"></div>
          <div class="dv-header">% Daily Value*</div>

          <!-- Nutrients -->
          <div class="nutrient-row bold" style="border-top:3px solid #000">
            <span><span class="bold">Total Fat</span> <span class="editable" contenteditable="true" spellcheck="false">8g</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">10%</span>
          </div>
          <div class="nutrient-row indent1">
            <span>Saturated Fat <span class="editable" contenteditable="true" spellcheck="false">1g</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">5%</span>
          </div>
          <div class="nutrient-row indent1">
            <span><em>Trans</em> Fat <span class="editable" contenteditable="true" spellcheck="false">0g</span></span>
            <span></span>
          </div>
          <div class="nutrient-row bold">
            <span><span class="bold">Cholesterol</span> <span class="editable" contenteditable="true" spellcheck="false">0mg</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">0%</span>
          </div>
          <div class="nutrient-row bold">
            <span><span class="bold">Sodium</span> <span class="editable" contenteditable="true" spellcheck="false">160mg</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">7%</span>
          </div>
          <div class="nutrient-row bold">
            <span><span class="bold">Total Carbohydrate</span> <span class="editable" contenteditable="true" spellcheck="false">37g</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">13%</span>
          </div>
          <div class="nutrient-row indent1">
            <span>Dietary Fiber <span class="editable" contenteditable="true" spellcheck="false">4g</span></span>
            <span class="bold editable" contenteditable="true" spellcheck="false">14%</span>
          </div>
          <div class="nutrient-row indent1">
            <span>Total Sugars <span class="editable" contenteditable="true" spellcheck="false">12g</span></span>
            <span></span>
          </div>
          <div class="nutrient-row indent2" style="border-top:none">
            <span>Includes <span class="editable" contenteditable="true" spellcheck="false">10g</span> Added Sugars</span>
            <span class="bold editable" contenteditable="true" spellcheck="false">20%</span>
          </div>
          <div class="nutrient-row bold" style="border-top:4px solid #000; padding-top:2px">
            <span><span class="bold">Protein</span> <span class="editable" contenteditable="true" spellcheck="false">3g</span></span>
            <span></span>
          </div>

          <div class="thick-bar"></div>

          <!-- Micronutrients -->
          <div class="micro-section">
            <div class="micro-row">
              <span>Vitamin D <span class="editable" contenteditable="true" spellcheck="false">2mcg</span></span>
              <span class="editable" contenteditable="true" spellcheck="false">10%</span>
            </div>
            <div class="micro-row">
              <span>Calcium <span class="editable" contenteditable="true" spellcheck="false">260mg</span></span>
              <span class="editable" contenteditable="true" spellcheck="false">20%</span>
            </div>
            <div class="micro-row">
              <span>Iron <span class="editable" contenteditable="true" spellcheck="false">8mg</span></span>
              <span class="editable" contenteditable="true" spellcheck="false">45%</span>
            </div>
            <div class="micro-row">
              <span>Potassium <span class="editable" contenteditable="true" spellcheck="false">240mg</span></span>
              <span class="editable" contenteditable="true" spellcheck="false">6%</span>
            </div>
          </div>

          <!-- Footnote -->
          <div class="footnote">
            <span class="editable" contenteditable="true" spellcheck="false">* The % Daily Value (DV) tells you how much a nutrient in a serving of food contributes to a daily diet. 2,000 calories a day is used for general nutrition advice.</span>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ RIGHT PANEL: Field Quick Edit â”€â”€ -->
    <div class="w-full lg:w-56 flex-shrink-0 space-y-4">
      <div class="panel p-4">
        <div class="panel-title">Quick Tips</div>
        <ul class="text-slate-400 text-xs space-y-2">
          <li>ðŸ’¡ Click any value on the label to edit it directly</li>
          <li>ðŸ’¡ Use Tab to move between fields</li>
          <li>ðŸ’¡ Change font via the Font Style panel</li>
          <li>ðŸ’¡ Adjust label width with the slider</li>
          <li>ðŸ’¡ Disable Edit Mode before exporting for a clean look</li>
          <li>ðŸ’¡ PDF preserves exact label dimensions</li>
        </ul>
      </div>

      <div class="panel p-4">
        <div class="panel-title">Label Background</div>
        <label class="block mb-1">Color</label>
        <input type="color" id="bgColor" value="#ffffff" oninput="document.getElementById('label').style.background=this.value" class="w-full h-8 rounded cursor-pointer border-0 bg-transparent">
        <label class="block mt-3 mb-1">Text Color</label>
        <input type="color" id="textColor" value="#000000" oninput="document.getElementById('label').style.color=this.value" class="w-full h-8 rounded cursor-pointer border-0 bg-transparent">
      </div>

      <div class="panel p-4">
        <div class="panel-title">Bar Colors</div>
        <label class="block mb-1">Bar Color</label>
        <input type="color" id="barColor" value="#000000" oninput="updateBars(this.value)" class="w-full h-8 rounded cursor-pointer border-0 bg-transparent">
      </div>

      <div class="panel p-4">
        <div class="panel-title">Font Size</div>
        <label class="block mb-1">Base size: <span id="fsVal">13</span>px</label>
        <input type="range" min="8" max="20" value="13" oninput="updateFontSize(this.value)">
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  let editMode = true;
  const label = document.getElementById('label');

  function toggleEdit() {
    editMode = !editMode;
    const btn = document.getElementById('editToggleBtn');
    if (editMode) {
      label.classList.add('edit-mode');
      btn.textContent = '';
      btn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-8 8a2 2 0 01-.878.515l-3 .75a.5.5 0 01-.607-.607l.75-3a2 2 0 01.515-.878l8-8z"/></svg> Edit Mode: ON`;
      btn.classList.add('active');
      document.querySelectorAll('.editable').forEach(e => e.setAttribute('contenteditable','true'));
    } else {
      label.classList.remove('edit-mode');
      btn.innerHTML = `<svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10z" clip-rule="evenodd"/></svg> Edit Mode: OFF`;
      btn.classList.remove('active');
      document.querySelectorAll('.editable').forEach(e => e.setAttribute('contenteditable','false'));
    }
  }

  // Font change
  const fontFamilyMap = {
    // Serif
    'Frank+Ruhl+Libre:wght@400;700;900': 'Frank Ruhl Libre',
    'Playfair+Display:wght@400;700;900': 'Playfair Display',
    'Merriweather:wght@400;700;900': 'Merriweather',
    'Source+Serif+4:wght@400;700;900': 'Source Serif 4',
    'Libre+Baskerville:wght@400;700': 'Libre Baskerville',
    'DM+Serif+Display': 'DM Serif Display',
    'Crimson+Text:wght@400;700': 'Crimson Text',
    'Lora:wght@400;700': 'Lora',
    'EB+Garamond:wght@400;700;800': 'EB Garamond',
    'Cormorant+Garamond:wght@400;700': 'Cormorant Garamond',
    // Sans-Serif
    'Inter:wght@400;700;900': 'Inter',
    'DM+Sans:wght@400;700;900': 'DM Sans',
    'Manrope:wght@400;700;800': 'Manrope',
    'Plus+Jakarta+Sans:wght@400;700;800': 'Plus Jakarta Sans',
    'Outfit:wght@400;700;900': 'Outfit',
    'Nunito:wght@400;700;900': 'Nunito',
    'Poppins:wght@400;700;900': 'Poppins',
    'Mulish:wght@400;700;900': 'Mulish',
    'Figtree:wght@400;700;900': 'Figtree',
    'Noto+Sans:wght@400;700;900': 'Noto Sans',
    'Public+Sans:wght@400;700;900': 'Public Sans',
    'Rubik:wght@400;700;900': 'Rubik',
    'Karla:wght@400;700;800': 'Karla',
    'Lato:wght@400;700;900': 'Lato',
    'Raleway:wght@400;700;900': 'Raleway',
    'Work+Sans:wght@400;700;900': 'Work Sans',
    'Sora:wght@400;700;800': 'Sora',
    'Jost:wght@400;700;900': 'Jost',
    'Space+Grotesk:wght@400;700': 'Space Grotesk',
    // Condensed / Display
    'Oswald:wght@400;700': 'Oswald',
    'Roboto+Condensed:wght@400;700': 'Roboto Condensed',
    'Bebas+Neue': 'Bebas Neue',
    'Barlow+Condensed:wght@400;700': 'Barlow Condensed',
    'Fjalla+One': 'Fjalla One',
    'Big+Shoulders+Display:wght@400;700;900': 'Big Shoulders Display',
    'Antonio:wght@400;700': 'Antonio',
    // Monospace
    'JetBrains+Mono:wght@400;700': 'JetBrains Mono',
    'Space+Mono:wght@400;700': 'Space Mono',
    'IBM+Plex+Mono:wght@400;700': 'IBM Plex Mono',
    'Inconsolata:wght@400;700': 'Inconsolata',
  };

  function changeFont(val) {
    const link = document.getElementById('google-font-link');
    link.href = `https://fonts.googleapis.com/css2?family=${val}&display=swap`;
    const family = fontFamilyMap[val] || val.split(':')[0].replace(/\+/g,' ');
    document.documentElement.style.setProperty('--label-font', `'${family}', serif`);
    label.style.fontFamily = `'${family}', serif`;
    showToast(`Font changed to ${family}`);
  }

  function resizeLabel(val) {
    document.getElementById('widthVal').textContent = val;
    label.style.width = val + 'px';
  }

  function updateBorder(val) {
    document.getElementById('borderVal').textContent = val;
    label.style.borderWidth = val + 'px';
  }

  function updateBars(color) {
    document.querySelectorAll('#label .thick-bar, #label .medium-bar').forEach(b => b.style.background = color);
    label.style.borderColor = color;
    label.style.color = document.getElementById('textColor').value;
    document.querySelectorAll('#label .nutrient-row, #label .micro-row').forEach(r => r.style.borderTopColor = color);
  }

  function updateFontSize(val) {
    document.getElementById('fsVal').textContent = val;
    label.style.fontSize = val + 'px';
  }

  // â”€â”€ Clean clone capture â€” never touches the original label â”€â”€
  async function captureLabel(scale) {
    await document.fonts.ready;

    // 1. Deep-clone the label
    const clone = label.cloneNode(true);

    // 2. Strip ALL edit-mode visual artifacts from the clone
    clone.classList.remove('edit-mode');
    clone.removeAttribute('contenteditable');

    // 3. Nuke every editable span's styling and contenteditable
    clone.querySelectorAll('.editable').forEach(el => {
      el.removeAttribute('contenteditable');
      el.style.border        = 'none';
      el.style.borderBottom  = 'none';
      el.style.outline       = 'none';
      el.style.background    = 'transparent';
      el.style.boxShadow     = 'none';
      el.style.display       = 'inline';   // collapse min-width artifact
    });

    // 4. Copy all computed inline styles from original label
    //    so custom colours / widths / fonts are preserved
    const computed = window.getComputedStyle(label);
    clone.style.fontFamily   = computed.fontFamily;
    clone.style.fontSize     = computed.fontSize;
    clone.style.color        = label.style.color        || '#000000';
    clone.style.background   = label.style.background   || '#ffffff';
    clone.style.borderColor  = label.style.borderColor  || '#000000';
    clone.style.borderWidth  = label.style.borderWidth  || '2px';
    clone.style.width        = label.offsetWidth + 'px';

    // 5. Position off-screen so it lays out but isn't visible
    clone.style.position     = 'fixed';
    clone.style.top          = '-9999px';
    clone.style.left         = '-9999px';
    clone.style.zIndex       = '-1';
    clone.style.pointerEvents = 'none';
    document.body.appendChild(clone);

    // 6. Let the browser lay out the clone
    await new Promise(r => setTimeout(r, 300));

    const lw = clone.offsetWidth;
    const lh = clone.offsetHeight;

    // 7. Capture the clean clone
    const canvas = await html2canvas(clone, {
      scale,
      backgroundColor: label.style.backgroundColor || '#ffffff',
      useCORS: true,
      allowTaint: false,
      logging: false,
      width:  lw,
      height: lh,
      scrollX: 0,
      scrollY: 0,
      removeContainer: false,
    });

    // 8. Remove clone
    document.body.removeChild(clone);
    return { canvas, lw, lh };
  }

  // â”€â”€ Export PDF â”€â”€
  async function exportPDF() {
    showToast('Generating PDFâ€¦');
    try {
      const { canvas, lw, lh } = await captureLabel(3);
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const mmW = lw * 0.2645;
      const mmH = lh * 0.2645;
      const margin = 4;
      const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [mmW + margin*2, mmH + margin*2] });
      pdf.addImage(imgData, 'PNG', margin, margin, mmW, mmH, undefined, 'NONE');
      pdf.save('nutrition-label.pdf');
      showToast('PDF downloaded!');
    } catch(e) { showToast('Error: ' + e.message); console.error(e); }
  }

  // â”€â”€ Export PNG â”€â”€
  async function exportPNG() {
    showToast('Generating PNGâ€¦');
    try {
      const { canvas } = await captureLabel(4);
      const link = document.createElement('a');
      link.download = 'nutrition-label.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
      showToast('PNG downloaded!');
    } catch(e) { showToast('Error: ' + e.message); console.error(e); }
  }

  // â”€â”€ Reset â”€â”€
  const defaults = {};
  document.querySelectorAll('.editable').forEach((el, i) => { defaults[i] = el.textContent; });
  function resetLabel() {
    document.querySelectorAll('.editable').forEach((el, i) => { el.textContent = defaults[i] || el.textContent; });
    label.style.cssText = '';
    label.style.width = '340px';
    document.getElementById('widthVal').textContent = '340';
    document.getElementById('borderVal').textContent = '2';
    document.getElementById('fsVal').textContent = '13';
    label.classList.add('edit-mode');
    document.getElementById('bgColor').value = '#ffffff';
    document.getElementById('textColor').value = '#000000';
    document.getElementById('barColor').value = '#000000';
    showToast('Label reset to defaults!');
  }

  // â”€â”€ Toast â”€â”€
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2400);
  }
</script>
</body>
</html>
